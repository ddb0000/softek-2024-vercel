<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Demandas</title>
    <style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        color: #333;
        margin: 0;
        padding: 0;
    }

    .container {
        width: 90%;
        margin: 20px auto;
        background-color: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 2px solid #003366;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }

    h1 {
        color: #003366;
        margin: 0;
    }

    .filters {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 20px;
    }

    select {
        padding: 8px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 5px;
        background-color: #f9f9f9;
        flex-grow: 1;
    }

    .chart-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
    }

    .chart-container {
        padding: 10px;
        border: 1px solid #e0e0e0;
        border-radius: 5px;
        background-color: #fff;
    }

    #leadtime-table {
        margin-top: 20px;
        padding: 10px;
        border: 1px solid #e0e0e0;
        border-radius: 5px;
        background-color: #fff;
    }
    </style>
</head>
<body>

<div class="container">
    <header>
        <img src="dashboard-logo.png" alt="Dashboard Logo" height="50">
        <h1>DASHBOARD DE DEMANDAS</h1>
    </header>

<div class="filters">
    <select id="anomes-filter">
    </select>
    <select id="senioridade-filter">
    </select>
    <select id="area-filter">
    </select>
    <select id="complexidade-filter">
    </select>
</div>

    <div class="chart-grid">
        <div class="chart-container">
            <canvas id="abertura-encerramento-chart"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="encerrados-complexidade-chart"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="cargo-custo-chart"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="encerramentos-cargo-chart"></canvas>
        </div>
        <div class="chart-container">
            <div id="vol-cargo-complexidade-chart"></div>
        </div>
        <div class="chart-container">
            <div id="tma-cargo-complexidade-chart"></div>
        </div>
    </div>
    <div id="leadtime-table"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.8.0/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const dataFilePath = 'dashboard.json';
    let dashboardData;
    let chartInstances = {};

    function loadJSONData(filePath) {
        return fetch(filePath)
            .then(response => response.json())
            .then(data => {
                console.log('Loaded Data:', data);
                return data;
            })
            .catch(error => {
                console.error("Error loading JSON file:", error);
                return {};
            });
    }

    function updateFilters() {
    if (!dashboardData) return;

    const anomesRefOptions = dashboardData.aberturas_encerramento ? [...new Set(dashboardData.aberturas_encerramento.map(row => row.ANOMES_REF))] : [];
    const senioridadeOptions = dashboardData.custo_medio_por_demanda ? [...new Set(dashboardData.custo_medio_por_demanda.map(row => row.SENIORIDADE))] : [];
    const complexidadeOptions = dashboardData.vol_cargo_complexidade ? [...new Set(dashboardData.vol_cargo_complexidade.map(row => row.COMPLEXIDADE))] : [];

    updateSelectOptions('anomes-filter', anomesRefOptions);
    updateSelectOptions('senioridade-filter', senioridadeOptions);
    updateSelectOptions('complexidade-filter', complexidadeOptions);
}

    function updateSelectOptions(selectId, options) {
    const select = document.getElementById(selectId);
    select.innerHTML = '<option value="">All</option>';
    options.forEach(option => {
        if (option) {
            const optionElement = document.createElement('option');
            optionElement.value = option;
            optionElement.textContent = option;
            select.appendChild(optionElement);
        }
    });
    console.log(`${selectId} populated with options:`, options);
}

    function applyFilters(data) {
    const anomesFilter = document.getElementById('anomes-filter').value;
    const senioridadeFilter = document.getElementById('senioridade-filter').value;
    const complexidadeFilter = document.getElementById('complexidade-filter').value;

    let filteredData = { ...data };

    if (anomesFilter) {
        filteredData.aberturas_encerramento = data.aberturas_encerramento.filter(item => item.ANOMES_REF == anomesFilter);
        filteredData.encerrados_complexidade = data.encerrados_complexidade.filter(item => item.ANOMES_STATUS == anomesFilter);
        filteredData.custo_medio_por_demanda = data.custo_medio_por_demanda.filter(item => item.ANOMES_STATUS == anomesFilter);
        filteredData.encerramentos_cargo = data.encerramentos_cargo.filter(item => item.ANOMES_STATUS == anomesFilter);
    }

    if (senioridadeFilter) {
        filteredData.custo_medio_por_demanda = filteredData.custo_medio_por_demanda.filter(item => item.SENIORIDADE == senioridadeFilter);
        filteredData.encerramentos_cargo = filteredData.encerramentos_cargo.filter(item => item.SENIORIDADE == senioridadeFilter);
        filteredData.vol_cargo_complexidade = filteredData.vol_cargo_complexidade.filter(item => item.SENIORIDADE == senioridadeFilter);
    }

    if (complexidadeFilter) {
        filteredData.vol_cargo_complexidade = filteredData.vol_cargo_complexidade.filter(item => item.COMPLEXIDADE == complexidadeFilter);
    }

    console.log("Filter values:", { anomesFilter, senioridadeFilter, complexidadeFilter });
    console.log("Filtered Data:", filteredData);

    return filteredData;
}

    function createCharts() {
    const filteredData = applyFilters(dashboardData);
    
    if (filteredData.aberturas_encerramento.length) createAberturaEncerramentoChart(filteredData.aberturas_encerramento);
    if (filteredData.encerrados_complexidade.length) createEncerradosComplexidadeChart(filteredData.encerrados_complexidade);
    if (filteredData.custo_medio_por_demanda.length) createCargoCustoChart(filteredData.custo_medio_por_demanda);
    if (filteredData.encerramentos_cargo.length) createEncerramentosCargoChart(filteredData.encerramentos_cargo);
    if (filteredData.tma_cargo_complexidade && filteredData.tma_cargo_complexidade.length) createTMACargoComplexidadeTable(filteredData.tma_cargo_complexidade);
    if (filteredData.lead_time && filteredData.lead_time.length) createLeadTimeTable(filteredData.lead_time);
    if (filteredData.vol_cargo_complexidade.length) createVolCargoComplexidadeTable(filteredData.vol_cargo_complexidade);

}

    function createAberturaEncerramentoChart(filteredData) {
        const ctx = document.getElementById('abertura-encerramento-chart').getContext('2d');
        const data = processDataForAberturaEncerramento(filteredData);

        if (chartInstances.aberturaEncerramento) {
            chartInstances.aberturaEncerramento.destroy();
        }

        chartInstances.aberturaEncerramento = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: 'Aberturas',
                        data: data.aberturas,
                        backgroundColor: '#003f5c',
                        borderColor: '#003f5c',
                        borderWidth: 1
                    },
                    {
                        label: 'Encerramentos',
                        data: data.encerramentos,
                        backgroundColor: '#bc5090',
                        borderColor: '#bc5090',
                        borderWidth: 1
                    },
                    {
                        label: '% Aderência',
                        data: data.percentAderencia,
                        type: 'line',
                        borderColor: '#ffa600',
                        borderWidth: 2,
                        fill: false,
                        yAxisID: 'y-axis-2',
                        lineTension: 0.3,
                        pointBackgroundColor: '#ffa600',
                        pointBorderColor: '#ffa600',
                        pointRadius: 5
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Quantidade'
                        }
                    },
                    'y-axis-2': {
                        min: 0,
                        max: 120,
                        position: 'right',
                        grid: {
                            drawOnChartArea: false
                        },
                        title: {
                            display: true,
                            text: '% Aderência'
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Aberturas x Encerramento',
                        padding: {
                            top: 10,
                            bottom: 30
                        }
                    },
                    legend: {
                        position: 'top',
                        labels: {
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            }
        });
    }

    function processDataForAberturaEncerramento(filteredData) {
        const labels = filteredData.map(item => item.ANOMES_REF);
        const aberturas = filteredData.map(item => item.ABERTURAS);
        const encerramentos = filteredData.map(item => item.ENCERRAMENTO);
        const percentAderencia = filteredData.map(item => item["%_ADERENCIA"]);

        return {
            labels: labels,
            aberturas: aberturas,
            encerramentos: encerramentos,
            percentAderencia: percentAderencia
        };
    }

    function createEncerradosComplexidadeChart() {
        const ctx = document.getElementById('encerrados-complexidade-chart').getContext('2d');
        const data = processDataForEncerradosComplexidade();

        if (chartInstances.encerradosComplexidade) {
            chartInstances.encerradosComplexidade.destroy();
        }

        chartInstances.encerradosComplexidade = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: data.datasets
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Encerrados x Complexidade'
                    },
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function processDataForEncerradosComplexidade() {
        const data = dashboardData.encerrados_complexidade;
        const labels = data.map(item => item.ANOMES_STATUS);
        const datasets = [
            {
                label: 'N1',
                data: data.map(item => item.N1),
                borderColor: 'rgba(54, 162, 235, 1)',
                fill: false
            },
            {
                label: 'N2',
                data: data.map(item => item.N2),
                borderColor: 'rgba(255, 99, 132, 1)',
                fill: false
            },
            {
                label: 'N3',
                data: data.map(item => item.N3),
                borderColor: 'rgba(75, 192, 192, 1)',
                fill: false
            }
        ];

        return {
            labels: labels,
            datasets: datasets
        };
    }

    function createCargoCustoChart(filteredData) {
    const ctx = document.getElementById('cargo-custo-chart').getContext('2d');
    const data = processDataForCargoCusto(filteredData);

    if (chartInstances.cargoCusto) {
        chartInstances.cargoCusto.destroy();
    }

    chartInstances.cargoCusto = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Bg', 'Ex', 'Jr', 'Pr', 'Sr'],
            datasets: [
                {
                    label: '202401',
                    data: [15.0, 83.13, 25.0, 55.97, 71.65],
                    backgroundColor: '#007bff',
                },
                {
                    label: '202402',
                    data: [13.64, 81.82, 22.73, 46.48, 60.99],
                    backgroundColor: '#ff6347',
                },
                {
                    label: '202403',
                    data: [13.64, 77.53, 22.73, 50.85, 64.91],
                    backgroundColor: '#32cd32',
                }
            ]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            scales: {
                x: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Custo Médio'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Senioridade'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Cargo x Custo Médio por Demanda',
                },
                legend: {
                    display: true,
                    position: 'left',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                }
            }
        }
    });
}

    function processDataForCargoCusto(filteredData) {
    const labels = filteredData.map(item => item.SENIORIDADE);
    const values = filteredData.map(item => item.CUSTO_MEDIO);

    return {
        labels: labels,
        values: values
    };
}

    function createEncerramentosCargoChart() {
    const ctx = document.getElementById('encerramentos-cargo-chart').getContext('2d');
    const data = processDataForEncerramentosCargo();

    if (chartInstances.encerramentosCargo) {
        chartInstances.encerramentosCargo.destroy();
    }

    chartInstances.encerramentosCargo = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Bg', 'Ex', 'Jr', 'Pr', 'Sr'],
            datasets: [
                {
                    label: '202401',
                    data: [92, 20, 68, 48, 110],
                    backgroundColor: '#007bff',
                },
                {
                    label: '202402',
                    data: [56, 24, 57, 77, 77],
                    backgroundColor: '#ff6347',
                },
                {
                    label: '202403',
                    data: [55, 28, 86, 43, 35],
                    backgroundColor: '#32cd32',
                }
            ]
        },
        options: {
            indexAxis: 'x',
            responsive: true,
            scales: {
                x: {
                    stacked: true,
                    title: {
                        display: true,
                        text: 'Cargo'
                    }
                },
                y: {
                    beginAtZero: true,
                    stacked: true,
                    title: {
                        display: true,
                        text: 'Número de Encerramentos'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Encerramentos x Cargo',
                    font: {
                        size: 16
                    }
                },
                legend: {
                    display: true,
                    position: 'bottom',
                    labels: {
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            }
        }
    });
}

    function processDataForEncerramentosCargo() {
        const data = dashboardData.encerramentos_cargo;
        const labels = data.map(item => item.SENIORIDADE);
        const values = data.map(item => item.ENCERRAMENTOS);

        return {
            labels: labels,
            values: values
        };
    }

    function createVolCargoComplexidadeTable(filteredData) {
    const tableContainer = document.getElementById('vol-cargo-complexidade-chart');
    const data = processDataForVolCargoComplexidade(filteredData);

    let tableHTML = '<table style="border-collapse: collapse; width: 100%;">';
    tableHTML += '<thead><tr><th style="background-color: #2C3E50; color: white; padding: 5px;">Complexidade</th>';
    data.labels.forEach(label => {
        tableHTML += `<th style="background-color: #2C3E50; color: white; padding: 5px;">${label}</th>`;
    });
    tableHTML += '</tr></thead><tbody>';

    data.datasets.forEach((dataset, rowIndex) => {
        tableHTML += `<tr style="background-color: ${rowIndex % 2 === 0 ? '#ecf0f1' : '#ffffff'};">`;
        tableHTML += `<td style="font-weight: bold; padding: 5px; text-align: center; background-color: #BDC3C7;">${dataset.label}</td>`;
        dataset.data.forEach(value => {
            let backgroundColor;
            if (value >= 150) {
                backgroundColor = '#e74c3c';
            } else if (value >= 75) {
                backgroundColor = '#f1c40f';
            } else if (value >= 25) {
                backgroundColor = '#2ecc71';
            } else {
                backgroundColor = '#95a5a6';
            }
            tableHTML += `<td style="padding: 5px; text-align: center; background-color: ${backgroundColor};">${value}</td>`;
        });
        tableHTML += '</tr>';
    });

    tableHTML += '</tbody></table>';
    tableContainer.innerHTML = tableHTML;
}

    function processDataForVolCargoComplexidade(filteredData) {
    const complexidades = [...new Set(filteredData.map(item => item.COMPLEXIDADE))];
    const senioridades = [...new Set(filteredData.map(item => item.SENIORIDADE))];

    const datasets = complexidades.map(complexidade => {
        return {
            label: complexidade,
            data: senioridades.map(senioridade => {
                return filteredData.find(item => item.SENIORIDADE === senioridade && item.COMPLEXIDADE === complexidade)?.VOLUME || 0;
            })
        };
    });

    return {
        labels: senioridades,
        datasets: datasets
    };
}

    function createTMACargoComplexidadeTable(filteredData) {
    const tableContainer = document.getElementById('tma-cargo-complexidade-chart');
    const data = processDataForTMACargoComplexidade(filteredData);

    let tableHTML = '<table style="border-collapse: collapse; width: 100%;">';
    tableHTML += '<thead><tr><th style="background-color: #2C3E50; color: white; padding: 5px;">Complexidade</th>';
    data.labels.forEach(label => {
        tableHTML += `<th style="background-color: #2C3E50; color: white; padding: 5px;">${label}</th>`;
    });
    tableHTML += '</tr></thead><tbody>';

    data.datasets.forEach((dataset, rowIndex) => {
        tableHTML += `<tr style="background-color: ${rowIndex % 2 === 0 ? '#ecf0f1' : '#ffffff'};">`;
        tableHTML += `<td style="font-weight: bold; padding: 5px; text-align: center; background-color: #BDC3C7;">${dataset.label}</td>`;
        dataset.data.forEach(value => {
            let backgroundColor;
            if (value >= 12) {
                backgroundColor = '#e74c3c';
            } else if (value >= 8) {
                backgroundColor = '#f1c40f';
            } else if (value >= 4) {
                backgroundColor = '#2ecc71';
            } else {
                backgroundColor = '#95a5a6';
            }
            tableHTML += `<td style="padding: 5px; text-align: center; background-color: ${backgroundColor};">${value.toFixed(1)}</td>`;
        });
        tableHTML += '</tr>';
    });

    tableHTML += '</tbody></table>';
    tableContainer.innerHTML = tableHTML;
}

    function processDataForTMACargoComplexidade(filteredData) {
    const complexidades = ['N1', 'N2', 'N3'];
    const senioridades = ['Bg', 'Ex', 'Jr', 'Pr', 'Sr']

    const datasets = complexidades.map(complexidade => {
        return {
            label: complexidade,
            data: senioridades.map(senioridade => {
                return filteredData.find(item => item.SENIORIDADE === senioridade && item.COMPLEXIDADE === complexidade)?.TMA || 0;
            })
        };
    });

    return {
        labels: senioridades,
        datasets: datasets
    };
}

    function createLeadTimeTable() {
        const tableContainer = document.getElementById('leadtime-table');
        const data = processDataForLeadTime();

        let tableHTML = '<table style="border-collapse: collapse; width: 100%;">';
        tableHTML += '<thead><tr><th style="background-color: #2C3E50; color: white; padding: 5px;">Complexidade</th>';

        // Create header for months and Total/Med
        data.anomes.forEach(anomes => {
            tableHTML += `<th style="background-color: #2C3E50; color: white; padding: 5px;">${anomes}</th>`;
        });

        tableHTML += '<th style="background-color: #2C3E50; color: white; padding: 5px;">Total</th>';
        tableHTML += '<th style="background-color: #2C3E50; color: white; padding: 5px;">Med.</th>';
        tableHTML += '</tr></thead><tbody>';

        data.complexidades.forEach(complexidade => {
            let total = 0;
            let count = 0;
            tableHTML += `<tr style="background-color: #BDC3C7;"><td style="font-weight: bold; padding: 5px; text-align: center;">${complexidade}</td>`;
            data.anomes.forEach(anomes => {
                const value = data.data[anomes] && data.data[anomes][complexidade]
                    ? data.data[anomes][complexidade]
                    : 0;
                total += value;
                if (value !== 0) count++;
                let backgroundColor;
                if (value > 100) {
                    backgroundColor = '#e74c3c';
                } else if (value > 50) {
                    backgroundColor = '#f1c40f';
                } else if (value > 0) {
                    backgroundColor = '#2ecc71';
                } else {
                    backgroundColor = '#95a5a6';s
                }
                tableHTML += `<td style="padding: 5px; text-align: center; background-color: ${backgroundColor};">${value}</td>`;
            });

            const average = total / (count || 1);
            tableHTML += `<td style="font-weight: bold; padding: 5px; text-align: center; background-color: #BDC3C7;">${total}</td>`;
            tableHTML += `<td style="font-weight: bold; padding: 5px; text-align: center; background-color: #BDC3C7;">${average.toFixed(1)}</td>`;
            tableHTML += '</tr>';
        });

        tableHTML += '</tbody></table>';
        tableContainer.innerHTML = tableHTML;
    }

    function processDataForLeadTime() {
        const data = dashboardData.lead_time;
        const anomes = [...new Set(data.map(item => item.ANOMES_STATUS))].sort();
        const complexidades = [...new Set(data.map(item => item.COMPLEXIDADE))];

        const tableData = {};
        anomes.forEach(anomes => {
            tableData[anomes] = {};
            complexidades.forEach(complexidade => {
                const relevantData = data.filter(item => item.ANOMES_STATUS === anomes && item.COMPLEXIDADE === complexidade);
                if (relevantData.length > 0) {
                    tableData[anomes][complexidade] = relevantData.reduce((sum, row) => sum + row.LEAD_TIME, 0) / relevantData.length;
                } else {
                    tableData[anomes][complexidade] = 0;points
                }
            });
        });

        return {
            anomes: anomes,
            complexidades: complexidades,
            data: tableData
        };
    }

    function getRandomColor() {
        return `hsl(${Math.random() * 360}, 70%, 50%)`;
    }

    loadJSONData(dataFilePath).then(data => {
        dashboardData = data;
        updateFilters();
        createCharts();

        document.querySelectorAll('select').forEach(select => {
            select.addEventListener('change', () => {
                createCharts();
            });
        });
    });
});

</script>
</body>
</html>