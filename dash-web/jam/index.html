<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Demandas</title>
    <style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        color: #333;
        margin: 0;
        padding: 0;
    }

    .container {
        width: 90%;
        margin: 20px auto;
        background-color: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 2px solid #003366;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }

    h1 {
        color: #003366;
        margin: 0;
    }

    .filters {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 20px;
    }

    select {
        padding: 8px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 5px;
        background-color: #f9f9f9;
        flex-grow: 1;
    }

    .chart-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
    }

    .chart-container {
        padding: 10px;
        border: 1px solid #e0e0e0;
        border-radius: 5px;
        background-color: #fff;
    }

    #leadtime-table {
        margin-top: 20px;
        padding: 10px;
        border: 1px solid #e0e0e0;
        border-radius: 5px;
        background-color: #fff;
    }
    </style>
</head>
<body>

<div class="container">
    <header>
        <img src="dashboard-logo.png" alt="Dashboard Logo" height="50">
        <h1>DASHBOARD DE DEMANDAS</h1>
    </header>

<div class="filters">
    <select id="anomes-filter">
    </select>
    <select id="senioridade-filter">
    </select>
    <select id="area-filter">
    </select>
    <select id="complexidade-filter">
    </select>
</div>

    <div class="chart-grid">
        <div class="chart-container">
            <canvas id="abertura-encerramento-chart"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="encerrados-complexidade-chart"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="cargo-custo-chart"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="encerramentos-cargo-chart"></canvas>
        </div>
        <div class="chart-container">
            <div id="vol-cargo-complexidade-chart"></div>
        </div>
        <div class="chart-container">
            <div id="tma-cargo-complexidade-chart"></div>
        </div>
    </div>
    <div id="leadtime-table"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.8.0/chart.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const dataFiles = ['cubo1_consolidado.json', 'cubo2_consolidado.json', 'cubo3_alocacao_recursos.json'];
    let cuboData = { cubo1Data: [], cubo2Data: [], cubo3Data: [] };
    let chartInstances = {};

    async function loadJSONData(filePaths) {
        try {
            const promises = filePaths.map(filePath => fetch(filePath).then(response => response.json()));
            const [cubo1Data, cubo2Data, cubo3Data] = await Promise.all(promises);
            console.log('Data loaded successfully:', { cubo1Data, cubo2Data, cubo3Data });
            return { cubo1Data, cubo2Data, cubo3Data };
        } catch (error) {
            console.error('Error loading JSON data:', error);
            return { cubo1Data: [], cubo2Data: [], cubo3Data: [] };
        }
    }

    function updateFilters() {
    if (!cuboData) return;

    const anomesOptions = cuboData.cubo2Data ? [...new Set(cuboData.cubo2Data.map(row => row.ANOMES_STATUS))] : [];
    const senioridadeOptions = cuboData.cubo2Data ? [...new Set(cuboData.cubo2Data.map(row => row.SENIORIDADE))] : [];
    const complexidadeOptions = cuboData.cubo2Data ? [...new Set(cuboData.cubo2Data.map(row => row.COMPLEXIDADE))] : [];
    const areaOptions = cuboData.cubo1Data ? [...new Set(cuboData.cubo1Data.map(row => row.ATRIBUTO))] : [];

    updateSelectOptions('anomes-filter', anomesOptions);
    updateSelectOptions('senioridade-filter', senioridadeOptions);
    updateSelectOptions('complexidade-filter', complexidadeOptions);
    updateSelectOptions('area-filter', areaOptions);
}
   
    function updateSelectOptions(selectId, options) {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">All</option>';
        options.forEach(option => {
            if (option) {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            }
        });
        console.log(`${selectId} populated with options:`, options);
    }

    function applyFilters(data) {
        const anomesFilter = document.getElementById('anomes-filter').value;
        const senioridadeFilter = document.getElementById('senioridade-filter').value;
        const complexidadeFilter = document.getElementById('complexidade-filter').value;

        let filteredData = {
            cubo1Data: data.cubo1Data || [],
            cubo2Data: data.cubo2Data || [],
            cubo3Data: data.cubo3Data || []
        };

        if (anomesFilter) {
            filteredData.cubo1Data = filteredData.cubo1Data.filter(item => item.ANOMES_REF === anomesFilter);
            filteredData.cubo2Data = filteredData.cubo2Data.filter(item => item.ANOMES_STATUS === anomesFilter);
            filteredData.cubo3Data = filteredData.cubo3Data.filter(item => item.ANOMES_ABERTURA === anomesFilter);
        }

        if (senioridadeFilter) {
            filteredData.cubo2Data = filteredData.cubo2Data.filter(item => item.SENIORIDADE === senioridadeFilter);
        }

        if (complexidadeFilter) {
            filteredData.cubo2Data = filteredData.cubo2Data.filter(item => item.COMPLEXIDADE === complexidadeFilter);
            filteredData.cubo3Data = filteredData.cubo3Data.filter(item => item.COMPLEXIDADE === complexidadeFilter);
        }

        console.log("Filter values:", { anomesFilter, senioridadeFilter, complexidadeFilter });
        console.log("Filtered Data:", filteredData);

        return filteredData;
    }

    function createCharts(data) {
        if (!data) {
            console.error("No data provided to create charts");
            return;
        }

        if (data.cubo1Data && data.cubo1Data.length) {
            createAberturaEncerramentoChart(data.cubo1Data);
        }
        if (data.cubo2Data && data.cubo2Data.length) {
            createEncerradosComplexidadeChart(data.cubo2Data);
            createCargoCustoChart(data.cubo2Data);
            createEncerramentosCargoChart(data.cubo2Data);
            createVolCargoComplexidadeTable(data.cubo2Data);
            createTMACargoComplexidadeTable(data.cubo2Data);
        }
        if (data.cubo3Data && data.cubo3Data.length) {
            createLeadTimeTable(data.cubo3Data);
        } else {
            console.error('cubo3Data is empty or undefined');
        }
    }

    function createEncerramentosCargoChart(data) {
    const ctx = document.getElementById('encerramentos-cargo-chart').getContext('2d');

    const labels = [...new Set(data.map(item => item.SENIORIDADE))];
    const dataset = labels.map(label => {
        const items = data.filter(item => item.SENIORIDADE === label);
        const totalEncerramentos = items.reduce((acc, curr) => acc + (curr.HORAS || 0), 0);
        return totalEncerramentos;
    });

    if (chartInstances.encerramentosCargo) {
        chartInstances.encerramentosCargo.destroy();
    }

    chartInstances.encerramentosCargo = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Encerramentos por Senioridade',
                data: dataset,
                backgroundColor: '#ff7f0e'
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Número de Encerramentos'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Senioridade'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Encerramentos por Senioridade'
                },
                legend: {
                    display: false
                }
            }
        }
    });
}

    function createCargoCustoChart(data) {
    const ctx = document.getElementById('cargo-custo-chart').getContext('2d');
    
    const labels = [...new Set(data.map(item => item.SENIORIDADE))];
    const dataset = labels.map(label => {
        const items = data.filter(item => item.SENIORIDADE === label);
        const totalValue = items.reduce((acc, curr) => acc + curr.VALOR_AT, 0);
        return totalValue / items.length;
    });

    if (chartInstances.cargoCusto) {
        chartInstances.cargoCusto.destroy();
    }

    chartInstances.cargoCusto = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Custo Médio',
                data: dataset,
                backgroundColor: '#007bff'
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Custo Médio'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Senioridade'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Custo Médio por Senioridade'
                },
                legend: {
                    display: false
                }
            }
        }
    });
}

    function createAberturaEncerramentoChart(data) {
        const ctx = document.getElementById('abertura-encerramento-chart').getContext('2d');
        const processedData = processDataForAberturaEncerramento(data);

        if (chartInstances.aberturaEncerramento) {
            chartInstances.aberturaEncerramento.destroy();
        }

        chartInstances.aberturaEncerramento = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: processedData.labels,
                datasets: [
                    {
                        label: 'Aberturas',
                        data: processedData.aberturas,
                        backgroundColor: '#003f5c',
                        borderColor: '#003f5c',
                        borderWidth: 1
                    },
                    {
                        label: 'Encerramentos',
                        data: processedData.encerramentos,
                        backgroundColor: '#bc5090',
                        borderColor: '#bc5090',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Quantidade'
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Aberturas x Encerramento',
                        padding: {
                            top: 10,
                            bottom: 30
                        }
                    },
                    legend: {
                        position: 'top',
                        labels: {
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            }
        });
    }

    function processDataForAberturaEncerramento(data) {
    const labels = [...new Set(data.map(item => item.ANOMES_REF))];

    const aberturas = data.filter(item => item.INDICADOR === 'ABERTURAS').map(item => item.CHAMADO);
    const encerramentos = data
        .filter(item => item.INDICADOR === 'ENCERRAMENTOS' || item.INDICADOR === 'ENCERRAMENTO')
        .map(item => item.CHAMADO);

    return {
        labels: labels,
        aberturas: aberturas,
        encerramentos: encerramentos
    };
}

    function createVolCargoComplexidadeTable(data) {
    const tableContainer = document.getElementById('vol-cargo-complexidade-chart');

    const complexidades = [...new Set(data.map(item => item.COMPLEXIDADE))];
    const senioridades = [...new Set(data.map(item => item.SENIORIDADE))];

    const datasets = complexidades.map(complexidade => {
        return {
            label: complexidade,
            data: senioridades.map(senioridade => {
                const matchingItem = data.find(item => item.SENIORIDADE === senioridade && item.COMPLEXIDADE === complexidade);
                return matchingItem ? matchingItem.HORAS : 0;
            })
        };
    });

    let tableHTML = '<table style="border-collapse: collapse; width: 100%;">';
    tableHTML += '<thead><tr><th style="background-color: #2C3E50; color: white; padding: 5px;">Complexidade</th>';
    senioridades.forEach(senioridade => {
        tableHTML += `<th style="background-color: #2C3E50; color: white; padding: 5px;">${senioridade}</th>`;
    });
    tableHTML += '</tr></thead><tbody>';

    datasets.forEach((dataset, rowIndex) => {
        tableHTML += `<tr style="background-color: ${rowIndex % 2 === 0 ? '#ecf0f1' : '#ffffff'};">`;
        tableHTML += `<td style="font-weight: bold; padding: 5px; text-align: center; background-color: #BDC3C7;">${dataset.label}</td>`;
        dataset.data.forEach(value => {
            let backgroundColor;
            if (value >= 150) {
                backgroundColor = '#e74c3c';
            } else if (value >= 75) {
                backgroundColor = '#f1c40f';
            } else if (value >= 25) {
                backgroundColor = '#2ecc71';
            } else {
                backgroundColor = '#95a5a6';
            }
            tableHTML += `<td style="padding: 5px; text-align: center; background-color: ${backgroundColor};">${value}</td>`;
        });
        tableHTML += '</tr>';
    });

    tableHTML += '</tbody></table>';
    tableContainer.innerHTML = tableHTML;
}

    function createEncerradosComplexidadeChart() {
        const ctx = document.getElementById('encerrados-complexidade-chart').getContext('2d');
        const data = processDataForEncerradosComplexidade();

        if (!data.labels.length) return;

        if (chartInstances.encerradosComplexidade) {
            chartInstances.encerradosComplexidade.destroy();
        }

        chartInstances.encerradosComplexidade = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: data.datasets
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Encerrados x Complexidade'
                    },
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function processDataForEncerradosComplexidade() {
        const data = cuboData.cubo2Data;

        if (!data || !data.length) {
            console.error('Data is undefined or empty:', data);
            return { labels: [], datasets: [] };
        }

        const labels = [...new Set(data.map(item => item.ANOMES_STATUS))];
        const datasets = ['N1', 'N2', 'N3'].map(complexidade => ({
            label: complexidade,
            data: data.filter(item => item.COMPLEXIDADE === complexidade).map(item => item.HORAS),
            borderColor: complexidade === 'N1' ? 'rgba(54, 162, 235, 1)' : complexidade === 'N2' ? 'rgba(255, 99, 132, 1)' : 'rgba(75, 192, 192, 1)',
            fill: false
        }));

        return {
            labels: labels,
            datasets: datasets
        };
    }

    function calculateLeadTime(cubo3Data, cubo2Data) {
    console.log('Starting calculateLeadTime');
    console.log('cubo3Data:', cubo3Data);
    console.log('cubo2Data:', cubo2Data);
    const leadTimeData = {};

    cubo3Data.forEach(task => {
        console.log('Processing task:', task);
        const openDate = new Date(task.DT_ABERTURA_CHAMADO);
        if (isNaN(openDate)) {
            console.error('Invalid open date detected:', task.DT_ABERTURA_CHAMADO);
            return;
        }

        cubo2Data.forEach(status => {
            console.log('Checking status:', status);
            if (status.ANOMES_STATUS === task.ANOMES_ABERTURA && status.COMPLEXIDADE === task.COMPLEXIDADE) {
                console.log('Match found');
                const statusYear = parseInt(status.ANOMES_STATUS.substring(0, 4), 10);
                const statusMonth = parseInt(status.ANOMES_STATUS.substring(4, 6), 10) - 1;
                const closeDate = new Date(statusYear, statusMonth + 1, 0);
                
                const leadTime = Math.ceil((closeDate - openDate) / (1000 * 60 * 60 * 24));
                console.log('Calculated lead time:', leadTime);

                const anomes = status.ANOMES_STATUS;
                const complexity = status.COMPLEXIDADE;

                if (!leadTimeData[anomes]) {
                    leadTimeData[anomes] = {};
                }

                if (!leadTimeData[anomes][complexity]) {
                    leadTimeData[anomes][complexity] = [];
                }

                leadTimeData[anomes][complexity].push(leadTime);
            }
        });
    });

    console.log('Final leadTimeData:', leadTimeData);
    return leadTimeData;
}

    function processDataForLeadTime(data) {
    console.log('Starting processDataForLeadTime');
    console.log('Input data:', data);
    const cubo3Data = data.cubo3Data || [];
    const cubo2Data = data.cubo2Data || [];
    const leadTimeData = calculateLeadTime(cubo3Data, cubo2Data);

    const anomes = [...new Set(cubo3Data.map(item => item.ANOMES_ABERTURA))].sort();
    const complexidades = [...new Set(cubo3Data.map(item => item.COMPLEXIDADE))];

    console.log('Unique anomes:', anomes);
    console.log('Unique complexidades:', complexidades);

    const tableData = {};

    anomes.forEach(month => {
        if (!leadTimeData[month]) return;
        tableData[month] = {};
        complexidades.forEach(complexidade => {
            const relevantData = leadTimeData[month] && leadTimeData[month][complexidade] ? leadTimeData[month][complexidade] : [];
            if (relevantData.length > 0) {
                tableData[month][complexidade] = relevantData.reduce((sum, lt) => sum + lt, 0) / relevantData.length;
            } else {
                tableData[month][complexidade] = 0;
            }
        });
    });

    console.log('Final tableData:', tableData);
    return {
        anomes: anomes,
        complexidades: complexidades,
        data: tableData
    };
}

    function createLeadTimeTable(data) {
    console.log('Starting createLeadTimeTable');
    console.log('Input data:', data);
    const tableContainer = document.getElementById('leadtime-table');
    if (!tableContainer) {
        console.error('Element with id "leadtime-table" not found');
        return;
    }

    const processedData = processDataForLeadTime(data);
    console.log('Processed data:', processedData);

    if (!processedData.anomes.length) {
        console.log('No anomes data available');
        return;
    }

    let tableHTML = '<table style="border-collapse: collapse; width: 100%;">';
    tableHTML += '<thead><tr><th style="background-color: #2C3E50; color: white; padding: 5px;">Complexidade</th>';

    processedData.anomes.forEach(anomes => {
        tableHTML += `<th style="background-color: #2C3E50; color: white; padding: 5px;">${anomes}</th>`;
    });

    tableHTML += '<th style="background-color: #2C3E50; color: white; padding: 5px;">Total</th>';
    tableHTML += '<th style="background-color: #2C3E50; color: white; padding: 5px;">Med.</th>';
    tableHTML += '</tr></thead><tbody>';

    processedData.complexidades.forEach(complexidade => {
        let total = 0;
        let count = 0;
        tableHTML += `<tr style="background-color: #BDC3C7;"><td style="font-weight: bold; padding: 5px; text-align: center;">${complexidade}</td>`;
        processedData.anomes.forEach(anomes => {
            const value = processedData.data[anomes] && processedData.data[anomes][complexidade]
                ? processedData.data[anomes][complexidade]
                : 0;
            total += value;
            if (value !== 0) count++;
            let backgroundColor;
            if (value > 100) {
                backgroundColor = '#e74c3c';
            } else if (value > 50) {
                backgroundColor = '#f1c40f';
            } else if (value > 0) {
                backgroundColor = '#2ecc71';
            } else {
                backgroundColor = '#95a5a6';
            }
            tableHTML += `<td style="padding: 5px; text-align: center; background-color: ${backgroundColor};">${value.toFixed(2)}</td>`;
        });

        const average = total / (count || 1);
        tableHTML += `<td style="font-weight: bold; padding: 5px; text-align: center; background-color: #BDC3C7;">${total.toFixed(2)}</td>`;
        tableHTML += `<td style="font-weight: bold; padding: 5px; text-align: center; background-color: #BDC3C7;">${average.toFixed(2)}</td>`;
        tableHTML += '</tr>';
    });

    tableHTML += '</tbody></table>';
    tableContainer.innerHTML = tableHTML;
    console.log('Table HTML generated:', tableHTML);
}

    function createTMACargoComplexidadeTable(data) {
    const tableContainer = document.getElementById('tma-cargo-complexidade-chart');

    const complexidades = [...new Set(data.map(item => item.COMPLEXIDADE))];
    const cargos = [...new Set(data.map(item => item.SENIORIDADE))];

    const tableData = {};
    cargos.forEach(cargo => {
        tableData[cargo] = {};
        complexidades.forEach(complexidade => {
            const relevantData = data.filter(item => item.SENIORIDADE === cargo && item.COMPLEXIDADE === complexidade);
            if (relevantData.length > 0) {
                tableData[cargo][complexidade] = relevantData.reduce((sum, row) => sum + (row.HORAS || 0), 0) / relevantData.length;
            } else {
                tableData[cargo][complexidade] = 0;
            }
        });
    });

    let tableHTML = '<table style="border-collapse: collapse; width: 100%;">';
    tableHTML += '<thead><tr><th style="background-color: #2C3E50; color: white; padding: 5px;">Cargo</th>';
    complexidades.forEach(complexidade => {
        tableHTML += `<th style="background-color: #2C3E50; color: white; padding: 5px;">${complexidade}</th>`;
    });
    tableHTML += '</tr></thead><tbody>';

    Object.keys(tableData).forEach(cargo => {
        tableHTML += `<tr style="background-color: #ecf0f1;"><td style="font-weight: bold; padding: 5px; text-align: center;">${cargo}</td>`;
        complexidades.forEach(complexidade => {
            const value = tableData[cargo][complexidade];
            let backgroundColor;
            if (value > 10) {
                backgroundColor = '#e74c3c';
            } else if (value > 5) {
                backgroundColor = '#f1c40f';
            } else if (value > 0) {
                backgroundColor = '#2ecc71';
            } else {
                backgroundColor = '#95a5a6';
            }
            tableHTML += `<td style="padding: 5px; text-align: center; background-color: ${backgroundColor};">${value.toFixed(2)}</td>`;
        });
        tableHTML += '</tr>';
    });

    tableHTML += '</tbody></table>';
    tableContainer.innerHTML = tableHTML;
}

    loadJSONData(dataFiles).then(data => {
        cuboData = data;
        console.log('Loaded Data:', cuboData);
        updateFilters();
        createCharts(cuboData);

        document.querySelectorAll('select').forEach(select => {
            select.addEventListener('change', () => {
                const filteredData = applyFilters(cuboData);
                createCharts(filteredData);
            });
        });
    });
    
});

</script>

</body>
</html>